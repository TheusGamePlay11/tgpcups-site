<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TGP Cups — Site</title>
  <meta name="description" content="Site oficial de TGP Cups." />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    /* --- seu CSS (reduzido) --- */
    body { background:#111; color:#eee; font-family:Inter, sans-serif; margin:0; }
    .container { max-width:1100px; margin:0 auto; padding:20px; }
    .nav { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .nav-links { display:flex; gap:12px; align-items:center; }
    button#discord-login { padding:8px 12px; background:linear-gradient(90deg,#667eea,#764ba2); color:#fff; border:0; border-radius:8px; cursor:pointer; font-weight:600; }
    img#user-avatar { width:42px; height:42px; border-radius:50%; display:none; cursor:pointer; }
    .user-info { display:flex; gap:8px; align-items:center; color:#ddd; }
    .user-name { font-weight:600; font-size:0.95rem; display:none; }
    /* responsivo */
    @media (max-width:768px){ .nav-links{flex-wrap:wrap;} }
  </style>
</head>
<body>
<header class="container nav">
  <a href="index.html" class="brand" style="display:flex;align-items:center;gap:8px;color:inherit;text-decoration:none;">
    <img src="https://cdn.discordapp.com/icons/1229519619442741288/e3ba5b3392773d67c40072c3fb247302.png?size=1024" alt="TGP Cups" style="width:36px;height:36px;border-radius:6px;">
    <span style="font-weight:700">TGP Cups</span>
  </a>

  <nav class="nav-links">
    <a href="index.html#inicio" style="color:inherit;text-decoration:none;">Início</a>
    <a href="servidores.html" style="color:inherit;text-decoration:none;">Parceiros</a>
    <a href="bots.html" style="color:inherit;text-decoration:none;">Bots</a>
    <a href="plataformas.html" style="color:inherit;text-decoration:none;">Plataformas</a>
    <a href="index.html#contato" style="color:inherit;text-decoration:none;">Contato</a>

    <div class="user-info">
      <button id="discord-login">Login com Discord</button>
      <img id="user-avatar" alt="Avatar do usuário" />
      <span class="user-name" id="user-name"></span>
    </div>
  </nav>
</header>

<main class="container">
  <!-- seu conteúdo -->
  <h1 style="color:#fff">TGP Cups</h1>
  <p>Participe das nossas competições de Torneios e Eventos.</p>
</main>

<footer class="container" style="padding:18px 20px;">
  <p>© <span id="ano"></span> TGP Cups. Todos os direitos reservados.</p>
</footer>

<script>
  // ---------- CONFIG ----------
  const CLIENT_ID = "1419041896080343070";
  const REDIRECT_URI = "https://theusgameplay11.github.io/tgpcups-site/";
  const BACKEND_URL = "https://seu-backend.example.com"; // <--- troque para o URL do seu backend (HTTPS!)
  const AUTH_URL = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=code&scope=identify`;

  const loginBtn = document.getElementById("discord-login");
  const userAvatar = document.getElementById("user-avatar");
  const userNameEl = document.getElementById("user-name");

  // Redireciona para o Discord (melhor do que abrir nova aba)
  loginBtn.addEventListener("click", () => {
    window.location.href = AUTH_URL;
  });

  // Gera a URL correta do avatar (tratando gif animado e avatar padrão)
  function getDiscordAvatarUrl(user, size = 128) {
    if (!user) return '';
    if (user.avatar) {
      const ext = user.avatar.startsWith('a_') ? 'gif' : 'png';
      return `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.${ext}?size=${size}`;
    } else {
      // se sem avatar, usa o avatar default (discriminator mod 5)
      const disc = user.discriminator || '0';
      const idx = parseInt(disc, 10) % 5;
      return `https://cdn.discordapp.com/embed/avatars/${idx}.png`;
    }
  }

  // Exibe o usuário no header
  function showUser(user) {
    if (!user) return;
    loginBtn.style.display = "none";
    userAvatar.src = getDiscordAvatarUrl(user, 128);
    userAvatar.style.display = "inline-block";
    userNameEl.textContent = `${user.username}${user.discriminator ? '#' + user.discriminator : ''}`;
    userNameEl.style.display = "inline-block";

    // logout simples
    userAvatar.addEventListener("click", () => {
      if (confirm("Deseja realmente sair?")) {
        localStorage.removeItem("discord_auth");
        userAvatar.style.display = "none";
        userNameEl.style.display = "none";
        loginBtn.style.display = "inline-block";
        // opcional: redireciona
        window.location.href = REDIRECT_URI;
      }
    });
  }

  // Ao carregar a página: processa "code" (se houver) ou carrega de localStorage
  window.addEventListener("load", async () => {
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");

    if (code) {
      try {
        // Troca o code pelo user via backend seguro
        const resp = await fetch(`${BACKEND_URL}/auth/discord`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code, redirect_uri: REDIRECT_URI })
        });

        const data = await resp.json();
        if (resp.ok && data.user) {
          // salva apenas o user (não salva tokens no front)
          localStorage.setItem("discord_auth", JSON.stringify({ user: data.user }));
          showUser(data.user);
          // limpa params da URL
          window.history.replaceState({}, document.title, REDIRECT_URI);
        } else {
          console.error("Erro trocando code:", data);
        }
      } catch (err) {
        console.error("Erro ao trocar code:", err);
      }
    } else {
      const saved = localStorage.getItem("discord_auth");
      if (saved) {
        try {
          const { user } = JSON.parse(saved);
          showUser(user);
        } catch (e) {
          console.error("Erro ao ler discord_auth:", e);
        }
      }
    }

    // atualiza ano
    document.getElementById("ano").textContent = new Date().getFullYear();
  });
</script>
</body>
</html>
